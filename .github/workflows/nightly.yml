# ============================================================
# OpenClaw æ±‰åŒ–å‘è¡Œç‰ˆ - æœ€æ–°ç‰ˆï¼ˆNightlyï¼‰è‡ªåŠ¨æ„å»ºå·¥ä½œæµ
# æ­¦æ±‰æ™´è¾°å¤©ä¸‹ç½‘ç»œç§‘æŠ€æœ‰é™å…¬å¸ | https://qingchencloud.com/
# ============================================================
#
# è§¦å‘æ–¹å¼ï¼š
#   - æ¯å°æ—¶42åˆ†è‡ªåŠ¨è¿è¡Œ
#   - æ‰‹åŠ¨è§¦å‘
#
# ç‰ˆæœ¬è¯´æ˜ï¼š
#   - æœ€æ–°ç‰ˆ (@nightly)ï¼šæœ¬å·¥ä½œæµå‘å¸ƒï¼Œæ¯å°æ—¶è‡ªåŠ¨æ„å»ºï¼Œè¿½è¸ªä¸Šæ¸¸æœ€æ–°ä»£ç 
#   - ç¨³å®šç‰ˆ (@latest)ï¼šsync-and-release.yml å‘å¸ƒï¼Œæ‰‹åŠ¨æ‰“ tag è§¦å‘
#
# ç”¨æˆ·å®‰è£…ï¼š
#   npm install -g @qingchencloud/openclaw-zh@nightly
# ============================================================

name: æœ€æ–°ç‰ˆæ„å»º (Nightly)

on:
  schedule:
    # æ¯å°æ—¶42åˆ†æ„å»ºï¼ˆé”™å³°é¿å…å†²çªï¼‰
    - cron: '42 * * * *'
  workflow_dispatch:
    inputs:
      force_build:
        description: 'å¼ºåˆ¶æ„å»ºï¼ˆè·³è¿‡ç‰ˆæœ¬æ£€æŸ¥ï¼‰'
        required: false
        default: 'false'
        type: boolean

env:
  UPSTREAM_REPO: openclaw/openclaw
  NODE_VERSION: '22'

permissions:
  contents: write
  packages: write

jobs:
  # ==================== Nightly æ„å»º ====================
  nightly-build:
    runs-on: ubuntu-latest
    
    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: è®¾ç½® Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          registry-url: 'https://registry.npmjs.org'

      - name: å®‰è£… pnpm
        uses: pnpm/action-setup@v4
        with:
          version: latest

      - name: è·å–ä¸Šæ¸¸ç‰ˆæœ¬ä¿¡æ¯
        id: upstream
        run: |
          UPSTREAM_VERSION=$(curl -s https://registry.npmjs.org/openclaw/latest | jq -r '.version')
          echo "version=$UPSTREAM_VERSION" >> $GITHUB_OUTPUT
          echo "ğŸ“¦ ä¸Šæ¸¸ç‰ˆæœ¬: $UPSTREAM_VERSION"

      - name: å…‹éš†ä¸Šæ¸¸ä»£ç 
        run: |
          git clone --depth 1 https://github.com/${{ env.UPSTREAM_REPO }}.git openclaw
          cd openclaw
          COMMIT_SHA=$(git rev-parse --short HEAD)
          echo "commit_sha=$COMMIT_SHA" >> $GITHUB_OUTPUT
          echo "âœ… ä¸Šæ¸¸ä»£ç å·²å…‹éš† (commit: $COMMIT_SHA)"

      - name: åº”ç”¨æ±‰åŒ–è¡¥ä¸
        id: apply
        run: |
          # è¿è¡Œæ±‰åŒ–å¹¶æ•è·è¾“å‡º
          OUTPUT=$(node cli/index.mjs apply --verbose 2>&1) || true
          echo "$OUTPUT"
          
          # æå–ç»Ÿè®¡ä¿¡æ¯ï¼ˆä½¿ç”¨ sed æ›¿ä»£ grep -Pï¼Œå…¼å®¹æ€§æ›´å¥½ï¼‰
          APPLIED=$(echo "$OUTPUT" | grep "æ€»è®¡:" | sed 's/.*åº”ç”¨ \([0-9]*\).*/\1/' || echo "0")
          EXISTED=$(echo "$OUTPUT" | grep "æ€»è®¡:" | sed 's/.*å·²å­˜åœ¨ \([0-9]*\).*/\1/' || echo "0")
          FAILED=$(echo "$OUTPUT" | grep "æ€»è®¡:" | sed 's/.*æœªæ‰¾åˆ° \([0-9]*\).*/\1/' || echo "0")
          FILES_COUNT=$(echo "$OUTPUT" | grep -c "æ›¿æ¢:" || echo "0")
          
          # å¦‚æœæå–å¤±è´¥ï¼Œè®¾ç½®é»˜è®¤å€¼
          [ -z "$APPLIED" ] && APPLIED="0"
          [ -z "$EXISTED" ] && EXISTED="0"
          [ -z "$FAILED" ] && FAILED="0"
          
          echo "applied=$APPLIED" >> $GITHUB_OUTPUT
          echo "existed=$EXISTED" >> $GITHUB_OUTPUT
          echo "failed=$FAILED" >> $GITHUB_OUTPUT
          echo "files=$FILES_COUNT" >> $GITHUB_OUTPUT
          
          echo ""
          echo "ğŸ“Š æ±‰åŒ–ç»Ÿè®¡ï¼š"
          echo "   âœ… åº”ç”¨è§„åˆ™: $APPLIED æ¡"
          echo "   â­ï¸ å·²å­˜åœ¨: $EXISTED æ¡"
          echo "   âš ï¸ æœªåŒ¹é…: $FAILED æ¡"
          echo "   ğŸ“ æ›¿æ¢æ“ä½œ: $FILES_COUNT æ¬¡"

      - name: éªŒè¯æ±‰åŒ–ç»“æœ
        run: |
          node cli/index.mjs verify || true
          echo "âœ… æ±‰åŒ–éªŒè¯å®Œæˆ"

      - name: æ„å»º OpenClaw
        working-directory: openclaw
        run: |
          pnpm install
          pnpm run build
          echo "âœ… æ„å»ºå®Œæˆ"

      - name: ä¿®å¤æ„å»ºäº§ç‰©ä¸­çš„å›¾æ ‡
        run: |
          # åˆ›å»º Python ä¿®å¤è„šæœ¬ - ä½¿ç”¨ emoji ğŸ¦ æ›¿ä»£ SVGï¼Œæ›´ç¨³å¦¥
          cat > /tmp/fix_icon.py << 'SCRIPT_EOF'
          import re
          import glob
          
          # ä½¿ç”¨ emoji æ›¿ä»£å¤æ‚çš„ SVGï¼Œé¿å…è½¬ä¹‰é—®é¢˜
          EMOJI_ICON = '<span style="font-size:28px;line-height:1;display:block">ğŸ¦</span>'
          
          pattern = r'<img src="https://mintcdn\.com/[^"]*pixel-lobster\.svg[^"]*" alt="OpenClaw"[^>]*>'
          
          for js_file in glob.glob("openclaw/dist/control-ui/assets/*.js"):
              with open(js_file, "r", encoding="utf-8") as f:
                  content = f.read()
              if "mintcdn.com" in content:
                  new_content = re.sub(pattern, EMOJI_ICON, content)
                  if content != new_content:
                      with open(js_file, "w", encoding="utf-8") as f:
                          f.write(new_content)
                      print(f"âœ… å›¾æ ‡å·²æ›¿æ¢ä¸º emoji: {js_file}")
                  else:
                      # å°è¯•å¤‡ç”¨æ–¹æ³•ï¼šç›´æ¥æŸ¥æ‰¾å¹¶æ›¿æ¢ img æ ‡ç­¾
                      start = content.find('<img')
                      while start != -1:
                          end = content.find('>', start) + 1
                          tag = content[start:end]
                          if 'pixel-lobster' in tag:
                              new_content = content[:start] + EMOJI_ICON + content[end:]
                              with open(js_file, "w", encoding="utf-8") as f:
                                  f.write(new_content)
                              print(f"âœ… å›¾æ ‡å·²æ›¿æ¢ä¸º emoji (å¤‡ç”¨æ–¹æ³•): {js_file}")
                              break
                          start = content.find('<img', end)
          SCRIPT_EOF
          
          python3 /tmp/fix_icon.py
          echo "âœ… å›¾æ ‡ä¿®å¤å®Œæˆ"

      - name: æ³¨å…¥åŠŸèƒ½é¢æ¿
        run: |
          python3 scripts/inject_panel.py
          echo "âœ… åŠŸèƒ½é¢æ¿æ³¨å…¥å®Œæˆ"

      - name: å‡†å¤‡ Nightly ç‰ˆæœ¬
        id: prepare
        run: |
          UPSTREAM_VERSION="${{ steps.upstream.outputs.version }}"
          # ä½¿ç”¨æ—¶é—´æˆ³ç¡®ä¿æ¯å°æ—¶ç‰ˆæœ¬å”¯ä¸€
          TIMESTAMP=$(date +%Y%m%d%H%M)
          NIGHTLY_VERSION="${UPSTREAM_VERSION}-nightly.${TIMESTAMP}"
          
          echo "nightly_version=$NIGHTLY_VERSION" >> $GITHUB_OUTPUT
          echo "build_date=$(date +%Y-%m-%d)" >> $GITHUB_OUTPUT
          echo "build_time=$(date +%H:%M)" >> $GITHUB_OUTPUT
          echo "ğŸ“¦ Nightly ç‰ˆæœ¬: $NIGHTLY_VERSION"
          
          # æ›´æ–° package.json
          cd openclaw
          npm version $NIGHTLY_VERSION --no-git-tag-version --allow-same-version || true
          
          # ä¿®æ”¹åŒ…ä¿¡æ¯
          jq '.name = "@qingchencloud/openclaw-zh"' package.json > tmp.json && mv tmp.json package.json
          jq '.description = "OpenClaw æ±‰åŒ–å‘è¡Œç‰ˆ (Nightly) - æ­¦æ±‰æ™´è¾°å¤©ä¸‹ç½‘ç»œç§‘æŠ€æœ‰é™å…¬å¸"' package.json > tmp.json && mv tmp.json package.json
          
          # ä½¿ç”¨ä¸­æ–‡ README
          cp ../README.md ./README.md

      - name: å‘å¸ƒåˆ° npm (nightly æ ‡ç­¾)
        working-directory: openclaw
        run: npm publish --access public --tag nightly
        env:
          NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}
        continue-on-error: true

      - name: åˆ é™¤æ—§çš„ nightly æ ‡ç­¾
        run: |
          git push origin :refs/tags/nightly || true
          echo "ğŸ—‘ï¸ å·²åˆ é™¤æ—§çš„ nightly æ ‡ç­¾"

      - name: åˆ›å»ºæ–°çš„ nightly æ ‡ç­¾
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git tag -fa nightly -m "Nightly build ${{ steps.prepare.outputs.build_date }} ${{ steps.prepare.outputs.build_time }}"
          git push origin nightly --force
          echo "ğŸ·ï¸ å·²åˆ›å»º nightly æ ‡ç­¾"

      - name: åˆ›å»º/æ›´æ–° Nightly Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: nightly
          name: "ğŸŒ™ Nightly Build - ${{ steps.prepare.outputs.build_date }} ${{ steps.prepare.outputs.build_time }}"
          prerelease: true
          body: |
            ## ğŸŒ™ OpenClaw æ±‰åŒ–ç‰ˆ - æœ€æ–°ç‰ˆ (Nightly)
            
            > âš ï¸ **è­¦å‘Š**ï¼šæ­¤ä¸ºæ¯å°æ—¶è‡ªåŠ¨æ„å»ºç‰ˆæœ¬ï¼Œè¿½è¸ªä¸Šæ¸¸æœ€æ–°ä»£ç ï¼Œå¯èƒ½åŒ…å«æœªå®Œå…¨æµ‹è¯•çš„æ›´æ”¹ã€‚
            > 
            > ğŸ”’ **éœ€è¦ç¨³å®šç‰ˆï¼Ÿ** è¯·å®‰è£… `@latest`ï¼š`npm install -g @qingchencloud/openclaw-zh@latest`
            
            **æ„å»ºæ—¶é—´**: ${{ steps.prepare.outputs.build_date }} ${{ steps.prepare.outputs.build_time }} (UTC)
            **ä¸Šæ¸¸ç‰ˆæœ¬**: ${{ steps.upstream.outputs.version }}
            **Nightly ç‰ˆæœ¬**: ${{ steps.prepare.outputs.nightly_version }}
            **å‘å¸ƒç±»å‹**: æœ€æ–°ç‰ˆ (Nightly) - æ¯å°æ—¶è‡ªåŠ¨æ„å»º
            
            ---
            
            ### ğŸ“Š æ±‰åŒ–ç»Ÿè®¡
            
            | æŒ‡æ ‡ | æ•°é‡ | çŠ¶æ€ |
            |------|------|------|
            | âœ… åº”ç”¨è§„åˆ™ | **${{ steps.apply.outputs.applied }}** æ¡ | æˆåŠŸ |
            | â­ï¸ å·²å­˜åœ¨ | ${{ steps.apply.outputs.existed }} æ¡ | è·³è¿‡ |
            | âš ï¸ æœªåŒ¹é… | ${{ steps.apply.outputs.failed }} æ¡ | éœ€å…³æ³¨ |
            | ğŸ“ æ›¿æ¢æ“ä½œ | ${{ steps.apply.outputs.files }} æ¬¡ | - |
            
            ---
            
            ### ğŸ“¦ å®‰è£… Nightly ç‰ˆæœ¬
            
            ```bash
            # å®‰è£… nightly ç‰ˆæœ¬
            npm install -g @qingchencloud/openclaw-zh@nightly
            
            # åˆ‡æ¢å›ç¨³å®šç‰ˆ
            npm install -g @qingchencloud/openclaw-zh@latest
            ```
            
            ---
            
            ### ğŸ”— ç›¸å…³é“¾æ¥
            
            - ğŸ”¥ å®˜ç½‘: https://openclaw.qt.cool/
            - ğŸ“– ç¨³å®šç‰ˆ: https://github.com/1186258278/OpenClawChineseTranslation/releases/latest
            - ğŸ“¦ npm: https://www.npmjs.com/package/@qingchencloud/openclaw-zh
            
            ---
            
            **æ­¦æ±‰æ™´è¾°å¤©ä¸‹ç½‘ç»œç§‘æŠ€æœ‰é™å…¬å¸** | https://qingchencloud.com/
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      # ==================== Docker é•œåƒæ„å»ºä¸æ¨é€ ====================
      - name: å‡†å¤‡ Docker æ„å»º
        run: |
          # å¤åˆ¶ Dockerfile å’Œ .dockerignore åˆ°æ„å»ºç›®å½•
          cp Dockerfile openclaw/Dockerfile
          cp .dockerignore openclaw/.dockerignore 2>/dev/null || true
          
          # éªŒè¯æ„å»ºäº§ç‰©å­˜åœ¨
          echo "ğŸ“¦ æ£€æŸ¥æ„å»ºäº§ç‰©..."
          ls -la openclaw/
          ls -la openclaw/dist/ || echo "âš ï¸ dist/ ç›®å½•ä¸å­˜åœ¨"
          ls -la openclaw/node_modules/ | head -20 || echo "âš ï¸ node_modules/ ç›®å½•ä¸å­˜åœ¨"
          
          # ç¡®ä¿ dist ç›®å½•å­˜åœ¨
          if [ ! -d "openclaw/dist" ]; then
            echo "âŒ é”™è¯¯ï¼šdist/ ç›®å½•ä¸å­˜åœ¨ï¼ŒDocker æ„å»ºå°†å¤±è´¥"
            exit 1
          fi
          
          echo "âœ… Docker æ„å»ºå‡†å¤‡å®Œæˆ"

      - name: è®¾ç½® Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: ç™»å½• GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: å‡†å¤‡ Docker å…ƒæ•°æ®
        id: docker_meta
        uses: docker/metadata-action@v5
        with:
          images: ghcr.io/${{ github.repository_owner }}/openclaw-zh
          tags: |
            type=raw,value=nightly
            type=raw,value=${{ steps.prepare.outputs.nightly_version }}

      - name: æ„å»ºå¹¶æ¨é€ Docker é•œåƒ
        uses: docker/build-push-action@v5
        with:
          context: ./openclaw
          push: true
          tags: ${{ steps.docker_meta.outputs.tags }}
          labels: ${{ steps.docker_meta.outputs.labels }}
          cache-from: type=gha
          cache-to: type=gha,mode=max
          platforms: linux/amd64,linux/arm64
        continue-on-error: true

      - name: è®¾ç½® Docker é•œåƒä¸ºå…¬å¼€
        run: |
          echo "ğŸ”“ è®¾ç½® Docker é•œåƒå¯è§æ€§ä¸º public..."
          curl -X PATCH \
            -H "Authorization: Bearer ${{ secrets.GITHUB_TOKEN }}" \
            -H "Accept: application/vnd.github.v3+json" \
            https://api.github.com/user/packages/container/openclaw-zh/versions \
            -d '{"visibility":"public"}' || true
        continue-on-error: true

      - name: æ„å»ºæ‘˜è¦
        run: |
          echo "## ğŸŒ™ Nightly æ„å»ºå®Œæˆ" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| é¡¹ç›® | å€¼ |" >> $GITHUB_STEP_SUMMARY
          echo "|------|-----|" >> $GITHUB_STEP_SUMMARY
          echo "| æ„å»ºæ—¶é—´ | ${{ steps.prepare.outputs.build_date }} ${{ steps.prepare.outputs.build_time }} |" >> $GITHUB_STEP_SUMMARY
          echo "| ä¸Šæ¸¸ç‰ˆæœ¬ | ${{ steps.upstream.outputs.version }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Nightly ç‰ˆæœ¬ | ${{ steps.prepare.outputs.nightly_version }} |" >> $GITHUB_STEP_SUMMARY
          echo "| åº”ç”¨è§„åˆ™ | ${{ steps.apply.outputs.applied }} æ¡ |" >> $GITHUB_STEP_SUMMARY
          echo "| æœªåŒ¹é…è§„åˆ™ | ${{ steps.apply.outputs.failed }} æ¡ |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ğŸ“¦ å®‰è£…æ–¹å¼" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**npm**: \`npm install -g @qingchencloud/openclaw-zh@nightly\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Docker**: \`docker pull ghcr.io/${{ github.repository_owner }}/openclaw-zh:nightly\`" >> $GITHUB_STEP_SUMMARY
